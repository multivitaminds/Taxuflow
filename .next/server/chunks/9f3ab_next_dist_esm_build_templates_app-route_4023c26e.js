module.exports=[903128,e=>{"use strict";var t=e.i(682544),a=e.i(477416),r=e.i(888760),i=e.i(178890),n=e.i(685495),s=e.i(590424),o=e.i(333238),l=e.i(531427),d=e.i(172393),c=e.i(501598),u=e.i(133377),p=e.i(15902),_=e.i(115676),m=e.i(110214),f=e.i(376296),g=e.i(193695);e.i(633637);var h=e.i(712539),w=e.i(498065),v=e.i(110043),R=e.i(233753),y=e.i(771665);async function S(e){try{let e=await (0,v.createClient)(),{data:{user:t}}=await e.auth.getUser();if(!t)return w.NextResponse.json({error:"Unauthorized"},{status:401});let{data:a}=await e.from("user_profiles").select("*").eq("id",t.id).single(),{data:r}=await e.from("subscriptions").select("*").eq("user_id",t.id).order("created_at",{ascending:!1}).limit(1).single(),i=r?.current_period_start?new Date(r.current_period_start):new Date(new Date().getFullYear(),new Date().getMonth(),1),n=r?.current_period_end?new Date(r.current_period_end):new Date,{data:s}=await e.from("api_key_usage").select("method, response_time_ms, status_code").gte("created_at",i.toISOString()).lte("created_at",n.toISOString()),{data:o}=await e.from("tax_filings").select("id, form_type, filing_status").eq("user_id",t.id).gte("created_at",i.toISOString()).lte("created_at",n.toISOString()),{data:l}=await e.from("w2_filings").select("id").eq("user_id",t.id).gte("created_at",i.toISOString()).lte("created_at",n.toISOString()),{data:d}=await e.from("nec_1099_filings").select("id").eq("user_id",t.id).gte("created_at",i.toISOString()).lte("created_at",n.toISOString()),c=s?.filter(e=>"GET"===e.method).length||0,u=s?.filter(e=>["POST","PUT","DELETE","PATCH"].includes(e.method)).length||0,p=o?.filter(e=>e.form_type?.includes("federal")).length||0,_=o?.filter(e=>e.form_type?.includes("state")).length||0,m=l?.length||0,f=d?.length||0,g={filings:{federal:{count:p,unitPrice:2.5,total:2.5*p},state:{count:_,unitPrice:1.5,total:1.5*_},w2:{count:m,unitPrice:1,total:+m},form1099:{count:f,unitPrice:1.25,total:1.25*f}},api:{reads:{count:c,unitPrice:.01,total:.01*Math.ceil(c/1e3)},writes:{count:u,unitPrice:.05,total:.05*Math.ceil(u/1e3)}},compliance:{identityVerifications:{count:0,unitPrice:2,total:0},einValidations:{count:0,unitPrice:.5,total:0}}},h=g.filings.federal.total+g.filings.state.total+g.filings.w2.total+g.filings.form1099.total+g.api.reads.total+g.api.writes.total+g.compliance.identityVerifications.total+g.compliance.einValidations.total,S=[],b=[];if((0,R.isStripeConfigured)()&&a?.stripe_customer_id)try{let e=(0,R.getStripeClient)();S=(await e.paymentMethods.list({customer:a.stripe_customer_id,type:"card"})).data.map(e=>({id:e.id,brand:e.card?.brand,last4:e.card?.last4,expMonth:e.card?.exp_month,expYear:e.card?.exp_year,isDefault:e.id===r?.metadata?.default_payment_method})),b=(await e.invoices.list({customer:a.stripe_customer_id,limit:10})).data.map(e=>({id:e.id,number:e.number,amount:e.amount_due/100,status:e.status,created:e.created,paidAt:e.status_transitions?.paid_at,invoiceUrl:e.hosted_invoice_url,invoicePdf:e.invoice_pdf}))}catch(e){console.error("[v0] Error fetching Stripe data:",e)}let x=r?.plan_type||"developer-free",E=(0,y.getPlanById)(x);return w.NextResponse.json({account:{email:t.email,companyName:a?.company_name,accountMode:a?.account_mode||"sandbox",stripeCustomerId:a?.stripe_customer_id},subscription:{id:r?.id,planId:x,planName:E?.name||"Developer Platform",status:r?.status||"active",currentPeriodStart:i.toISOString(),currentPeriodEnd:n.toISOString(),cancelAt:r?.cancel_at,features:E?.features||[]},usage:{period:{start:i.toISOString(),end:n.toISOString()},breakdown:g,subtotal:h,platformFee:E?.price||0,estimatedTotal:h+(E?.price||0)},paymentMethods:S,invoices:b,pricing:y.DEVELOPER_USAGE_PRICING,availablePlans:(0,y.getDeveloperPlans)()})}catch(e){return console.error("[v0] Billing API error:",e),w.NextResponse.json({error:"Internal server error"},{status:500})}}async function b(e){try{let t=await (0,v.createClient)(),{data:{user:a}}=await t.auth.getUser();if(!a)return w.NextResponse.json({error:"Unauthorized"},{status:401});if(!(0,R.isStripeConfigured)())return w.NextResponse.json({error:"Stripe not configured"},{status:500});let r=(0,R.getStripeClient)(),i=await e.json(),{action:n,planId:s,paymentMethodId:o}=i,{data:l}=await t.from("user_profiles").select("stripe_customer_id, email, company_name").eq("id",a.id).single(),d=l?.stripe_customer_id;if(d||(d=(await r.customers.create({email:a.email||l?.email,metadata:{user_id:a.id,company_name:l?.company_name||""}})).id,await t.from("user_profiles").update({stripe_customer_id:d}).eq("id",a.id)),"create_subscription"===n){let e=(0,y.getPlanById)(s);if(!e||!e.priceId)return w.NextResponse.json({error:"Invalid plan"},{status:400});let i=await r.subscriptions.create({customer:d,items:[{price:e.priceId}],payment_behavior:"default_incomplete",payment_settings:{save_default_payment_method:"on_subscription"},expand:["latest_invoice.payment_intent"],metadata:{user_id:a.id,plan_id:s}});await t.from("subscriptions").upsert({user_id:a.id,stripe_subscription_id:i.id,stripe_customer_id:d,plan_type:s,status:i.status,current_period_start:new Date(1e3*i.current_period_start).toISOString(),current_period_end:new Date(1e3*i.current_period_end).toISOString(),metadata:{plan_name:e.name}});let n=i.latest_invoice;return w.NextResponse.json({subscriptionId:i.id,clientSecret:n?.payment_intent?.client_secret})}if("create_setup_intent"===n){let e=await r.setupIntents.create({customer:d,payment_method_types:["card"],metadata:{user_id:a.id}});return w.NextResponse.json({clientSecret:e.client_secret})}if("add_payment_method"===n&&o)return await r.paymentMethods.attach(o,{customer:d}),await r.customers.update(d,{invoice_settings:{default_payment_method:o}}),w.NextResponse.json({success:!0});if("cancel_subscription"===n){let{data:e}=await t.from("subscriptions").select("stripe_subscription_id").eq("user_id",a.id).single();return e?.stripe_subscription_id&&(await r.subscriptions.update(e.stripe_subscription_id,{cancel_at_period_end:!0}),await t.from("subscriptions").update({cancel_at:new Date().toISOString()}).eq("user_id",a.id)),w.NextResponse.json({success:!0})}if("report_usage"===n){let{usageData:e}=i,{data:n}=await t.from("subscriptions").select("stripe_subscription_id").eq("user_id",a.id).single();if(n?.stripe_subscription_id)for(let t of(await r.subscriptions.retrieve(n.stripe_subscription_id)).items.data)t.price.recurring?.usage_type==="metered"&&await r.subscriptionItems.createUsageRecord(t.id,{quantity:e[t.price.lookup_key||""]||0,timestamp:Math.floor(Date.now()/1e3),action:"increment"});return w.NextResponse.json({success:!0})}return w.NextResponse.json({error:"Invalid action"},{status:400})}catch(e){return console.error("[v0] Billing API error:",e),w.NextResponse.json({error:"Internal server error"},{status:500})}}e.s(["GET",0,S,"POST",0,b],767698);var x=e.i(767698);let E=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/developers/billing/route",pathname:"/api/developers/billing",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/taxu-platform/v0-taxu-landing-page/app/api/developers/billing/route.ts",nextConfigOutput:"",userland:x}),{workAsyncStorage:P,workUnitAsyncStorage:I,serverHooks:C}=E;async function N(e,t,r){E.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let w="/api/developers/billing/route";w=w.replace(/\/index$/,"")||"/";let v=await E.prepare(e,t,{srcPage:w,multiZoneDraftMode:!1});if(!v)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:R,params:y,nextConfig:S,parsedUrl:b,isDraftMode:x,prerenderManifest:P,routerServerContext:I,isOnDemandRevalidate:C,revalidateOnlyGenerated:N,resolvedPathname:O,clientReferenceManifest:A,serverActionsManifest:T}=v,D=(0,o.normalizeAppPath)(w),q=!!(P.dynamicRoutes[D]||P.routes[O]),U=async()=>((null==I?void 0:I.render404)?await I.render404(e,t,b,!1):t.end("This page could not be found"),null);if(q&&!x){let e=!!P.routes[O],t=P.dynamicRoutes[D];if(t&&!1===t.fallback&&!e){if(S.experimental.adapterPath)return await U();throw new g.NoFallbackError}}let j=null;!q||E.isDev||x||(j="/index"===(j=O)?"/":j);let M=!0===E.isDev||!q,H=q&&!M;T&&A&&(0,s.setManifestsSingleton)({page:w,clientReferenceManifest:A,serverActionsManifest:T});let k=e.method||"GET",F=(0,n.getTracer)(),B=F.getActiveScopeSpan(),$={params:y,prerenderManifest:P,renderOpts:{experimental:{authInterrupts:!!S.experimental.authInterrupts},cacheComponents:!!S.cacheComponents,supportsDynamicResponse:M,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:S.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r,i)=>E.onRequestError(e,t,r,i,I)},sharedContext:{buildId:R}},K=new l.NodeNextRequest(e),V=new l.NodeNextResponse(t),G=d.NextRequestAdapter.fromNodeNextRequest(K,(0,d.signalFromNodeResponse)(t));try{let s=async e=>E.handle(G,$).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=F.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=a.get("next.route");if(r){let t=`${k} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${k} ${w}`)}),o=!!(0,i.getRequestMeta)(e,"minimalMode"),l=async i=>{var n,l;let d=async({previousCacheEntry:a})=>{try{if(!o&&C&&N&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await s(i);e.fetchMetrics=$.renderOpts.fetchMetrics;let l=$.renderOpts.pendingWaitUntil;l&&r.waitUntil&&(r.waitUntil(l),l=void 0);let d=$.renderOpts.collectedTags;if(!q)return await (0,p.sendResponse)(K,V,n,$.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,_.toNodeOutgoingHttpHeaders)(n.headers);d&&(t[f.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==$.renderOpts.collectedRevalidate&&!($.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&$.renderOpts.collectedRevalidate,r=void 0===$.renderOpts.collectedExpire||$.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:$.renderOpts.collectedExpire;return{value:{kind:h.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:r}}}}catch(t){throw(null==a?void 0:a.isStale)&&await E.onRequestError(e,t,{routerKind:"App Router",routePath:w,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:C})},!1,I),t}},c=await E.handleResponse({req:e,nextConfig:S,cacheKey:j,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:P,isRoutePPREnabled:!1,isOnDemandRevalidate:C,revalidateOnlyGenerated:N,responseGenerator:d,waitUntil:r.waitUntil,isMinimalMode:o});if(!q)return null;if((null==c||null==(n=c.value)?void 0:n.kind)!==h.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(l=c.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",C?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),x&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let g=(0,_.fromNodeOutgoingHttpHeaders)(c.value.headers);return o&&q||g.delete(f.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||g.get("Cache-Control")||g.set("Cache-Control",(0,m.getCacheControlHeader)(c.cacheControl)),await (0,p.sendResponse)(K,V,new Response(c.value.body,{headers:g,status:c.value.status||200})),null};B?await l(B):await F.withPropagatedContext(e.headers,()=>F.trace(c.BaseServerSpan.handleRequest,{spanName:`${k} ${w}`,kind:n.SpanKind.SERVER,attributes:{"http.method":k,"http.target":e.url}},l))}catch(t){if(t instanceof g.NoFallbackError||await E.onRequestError(e,t,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:C})},!1,I),q)throw t;return await (0,p.sendResponse)(K,V,new Response(null,{status:500})),null}}e.s(["handler",0,N,"patchFetch",0,function(){return(0,r.patchFetch)({workAsyncStorage:P,workUnitAsyncStorage:I})},"routeModule",0,E,"serverHooks",0,C,"workAsyncStorage",0,P,"workUnitAsyncStorage",0,I],903128)}];

//# sourceMappingURL=9f3ab_next_dist_esm_build_templates_app-route_4023c26e.js.map